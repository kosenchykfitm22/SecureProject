$projectPath = Join-Path $PSScriptRoot "SecureProject.csproj"
$logDir = Join-Path $PSScriptRoot "logs"

if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Force -Path $logDir | Out-Null
}

Write-Host "--- Static Analysis Started ---" -ForegroundColor Cyan

dotnet build $projectPath > "$logDir/static_analysis_log.txt" 2>&1
Write-Host "Static Analysis Log saved to logs/static_analysis_log.txt" -ForegroundColor Green

Write-Host "`n--- Dynamic Analysis Started ---" -ForegroundColor Cyan

"This is a safe file content." | Set-Content "safe_file.txt"


$payload = "safe_file.txt & echo VULNERABILITY_CONFIRMED"


$processInfo = New-Object System.Diagnostics.ProcessStartInfo
$processInfo.FileName = "dotnet"
$processInfo.Arguments = "run --project `"$projectPath`""
$processInfo.RedirectStandardInput = $true
$processInfo.RedirectStandardOutput = $true
$processInfo.UseShellExecute = $false

$process = [System.Diagnostics.Process]::Start($processInfo)
$process.StandardInput.WriteLine($payload)
$process.StandardInput.Close()

$output = $process.StandardOutput.ReadToEnd()
$process.WaitForExit()

$output | Out-File "$logDir/dynamic_analysis_log.txt"
Write-Host "Dynamic Analysis Log saved to logs/dynamic_analysis_log.txt" -ForegroundColor Green

if ($output -match "VULNERABILITY_CONFIRMED") {
    Write-Host "[CRITICAL] Command Injection Vulnerability Detected!" -ForegroundColor Red
}
else {
    Write-Host "[INFO] No obvious vulnerability detected via simple injection." -ForegroundColor Gray
}
